###############################################################################
#
# Copyright IBM Corp. 2023, 2026
#
# This code is free software; you can redistribute it and/or modify it
# under the terms provided by IBM in the LICENSE file that accompanied
# this code, including the "Classpath" Exception described therein.
###############################################################################

name: GitHub Actions OpenJCEPlus
run-name: ${{ github.actor }} is building and testing OpenJCEPlus üöÄ
on: [push]
jobs:
  Build-Test-OpenJCEPlus:
    name: Build and Test ${{ matrix.os }}.
    runs-on: ${{ matrix.os }}
    permissions:
      checks: write # Needed to publish a check from the Publish Test Report step below.
      contents: read # Needed to read the contents of the github repo and clone.
    strategy:
        matrix:
          # "windows-2022" os builds have been disabled since Open Crypto Kit does not have builds available for windows.
          os: [ubuntu-22.04]
          include:
            - os: ubuntu-22.04
              gskit_dir: amd64
              gskit_lib_name: libjgsk8iccs_64.so
              target_lib_bin_dir: jgskit-xa-64
              github_actions_runner_root: /
            #- os: windows-2022
            #  gskit_dir: windows_x86_64
            #  gskit_lib_name: jgsk8iccs_64.dll
            #  github_actions_runner_root: \
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server."
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          tree ${{ github.workspace }}
#      - name: Set up Visual Studio shell
#        uses: egor-tensin/vs-shell@v2
#        with:
#          arch: x64
      - name: 'Checkout Open Cryptography Kit C'
        uses: actions/checkout@v4
        with:
          repository: IBM/OpenCryptographyKitC
          ref: f3dde51a02675270adf994dc22c7f2853dc86ba6 # Branch V_8.9.18 on Jan 2nd 2026.
          path: ${{ github.workspace }}/OpenCryptographyKitC
      - name: Compile Open Cryptography Kit C
        run: |
          cd ${{ github.workspace }}/OpenCryptographyKitC/icc
          make -k OPSYS=AMD64_LINUX CONFIG=release create_all
          export LD_LIBRARY_PATH=${{ github.workspace }}/OpenCryptographyKitC/openssl-1.1.1/
          make -k OPSYS=AMD64_LINUX CONFIG=release all
          make -k OPSYS=AMD64_LINUX CONFIG=release iccpkg
          make -k OPSYS=AMD64_LINUX CONFIG=release show_config
          cd ..
          cd iccpkg
          make -k OPSYS=AMD64_LINUX CONFIG=release all
          cd ${{ github.workspace }}
      - name: Extract OCK SDK and Binary Tar File
        run: |
          mkdir ${{ github.workspace }}/OCK
          cd ${{ github.workspace }}/OCK
          cp ${{ github.workspace }}/OpenCryptographyKitC/package/jgsk_crypto.tar .
          cp ${{ github.workspace }}/OpenCryptographyKitC/package/jgsk_crypto_sdk.tar .
          ls -al
          tree
          tar -xvf jgsk_crypto.tar
          tar -xvf jgsk_crypto_sdk.tar
          mkdir jgsk_sdk/lib64
          cp ${{ matrix.gskit_lib_name }} jgsk_sdk/lib64
      - name: Setup Temurin JDK
        uses: actions/setup-java@v4
        with:
          java-version: '26-ea'
          distribution: 'temurin'
          architecture: 'x64'
      # Uncomment to capture all files in the runner for debugging purposes.          
      # - name: List Files In Entire Runner
      #   run: |
      #     tree ${{ matrix.github_actions_runner_root }}
      - name: Execute Maven Install Target And OpenJCEPlus Provider Tests
        run: >
          mvn
          --batch-mode
          '-Dock.library.path=${{ github.workspace }}/OCK/'
          '-DargLine=-Djava.library.path=${{ github.workspace }}/target/jgskit-xa-64'
          -Dtest='
          ibm.jceplus.junit.openjceplus.TestAll,
          ibm.jceplus.junit.TestMemStressAll,
          ibm.jceplus.junit.TestMultithread,
          ibm.jceplus.junit.openjceplus.integration.TestAll
          '
          install
        env:
          GSKIT_HOME: ${{ github.workspace }}/OCK/jgsk_sdk
          ENABLE_SANITIZERS: 1
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=0:suppressions=${{ github.workspace }}/.github/ubsan.supp:log_path=${{ github.workspace }}/target/ubsan-reports/ubsan
      - name: Check for UBSan errors in first test phase
        if: always()
        run: |
          if [ -d "${{ github.workspace }}/target/ubsan-reports" ] && [ "$(ls -A ${{ github.workspace }}/target/ubsan-reports)" ]; then
            echo "‚ö†Ô∏è UndefinedBehaviorSanitizer detected issues in first test phase:"
            cat ${{ github.workspace }}/target/ubsan-reports/ubsan.* || true
            echo "::warning::UBSan detected undefined behavior - see logs above"
          else
            echo "‚úÖ No UBSan errors detected in first test phase"
          fi
      - name: Execute Migrated Maven Install Target And OpenJCEPlus Provider Tests
        run: >
          mvn
          --batch-mode
          '-Dock.library.path=${{ github.workspace }}/OCK/'
          '-DargLine=-Djava.library.path=${{ github.workspace }}/target/jgskit-xa-64'
          '-Dgroups=OpenJCEPlus'
          -Dtest='
          ibm.jceplus.junit.suites.TestOpenJCEPlus,
          ibm.jceplus.junit.suites.TestMultiThreadOpenJCEPlus.java
          '
          install
        env:
          GSKIT_HOME: ${{ github.workspace }}/OCK/jgsk_sdk
          ENABLE_SANITIZERS: 1
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=0:suppressions=${{ github.workspace }}/.github/ubsan.supp:log_path=${{ github.workspace }}/target/ubsan-reports-2/ubsan
      - name: Check for UBSan errors in second test phase
        if: always()
        run: |
          if [ -d "${{ github.workspace }}/target/ubsan-reports-2" ] && [ "$(ls -A ${{ github.workspace }}/target/ubsan-reports-2)" ]; then
            echo "‚ö†Ô∏è UndefinedBehaviorSanitizer detected issues in second test phase:"
            cat ${{ github.workspace }}/target/ubsan-reports-2/ubsan.* || true
            echo "::warning::UBSan detected undefined behavior - see logs above"
          else
            echo "‚úÖ No UBSan errors detected in second test phase"
          fi
      - name: List UBSan Report Files
        if: always()
        run: |
          echo "üìÅ UBSan Report Directories:"
          if [ -d "${{ github.workspace }}/target/ubsan-reports" ]; then
            echo "First test phase reports:"
            ls -lah ${{ github.workspace }}/target/ubsan-reports/ || echo "  (empty)"
          fi
          if [ -d "${{ github.workspace }}/target/ubsan-reports-2" ]; then
            echo "Second test phase reports:"
            ls -lah ${{ github.workspace }}/target/ubsan-reports-2/ || echo "  (empty)"
          fi
      - name: Archive UBSan Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ubsan-reports
          path: |
            ${{ github.workspace }}/target/ubsan-reports/
            ${{ github.workspace }}/target/ubsan-reports-2/
          if-no-files-found: ignore
      #- name: List Files In The Entire Workspace
      #  run: |
      #    tree ${{ github.workspace }}
      - name: Archive openjceplus.jar
        uses: actions/upload-artifact@v4
        with:
          name: openjceplus.jar
          path: target/openjceplus.jar
      - name: Archive openjceplus-tests.jar
        uses: actions/upload-artifact@v4
        with:
          name: openjceplus-tests.jar
          path: target/openjceplus-tests.jar
      - name: Archive libjgskit.so
        uses: actions/upload-artifact@v4
        with:
          name: libjgskit.so
          path: target/${{ matrix.target_lib_bin_dir }}/libjgskit.so 
      - name: Archive OpenJCEPlus Assemblies
        uses: actions/upload-artifact@v4
        with:
          name: openjceplus-assemblies.zip
          path: target/openjceplus-assemblies.zip
      - run: echo "üçè This job's status is ${{ job.status }}."
  
  Valgrind-Memory-Check:
    name: Valgrind Memory Analysis
    runs-on: ubuntu-22.04
    permissions:
      checks: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Install Valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind
          valgrind --version
      - name: 'Checkout Open Cryptography Kit C'
        uses: actions/checkout@v4
        with:
          repository: IBM/OpenCryptographyKitC
          ref: f3dde51a02675270adf994dc22c7f2853dc86ba6
          path: ${{ github.workspace }}/OpenCryptographyKitC
      - name: Compile Open Cryptography Kit C
        run: |
          cd ${{ github.workspace }}/OpenCryptographyKitC/icc
          make -k OPSYS=AMD64_LINUX CONFIG=release create_all
          export LD_LIBRARY_PATH=${{ github.workspace }}/OpenCryptographyKitC/openssl-1.1.1/
          make -k OPSYS=AMD64_LINUX CONFIG=release all
          make -k OPSYS=AMD64_LINUX CONFIG=release iccpkg
          cd ${{ github.workspace }}/OpenCryptographyKitC/iccpkg
          make -k OPSYS=AMD64_LINUX CONFIG=release all
      - name: Extract OCK SDK and Binary Tar File
        run: |
          mkdir ${{ github.workspace }}/OCK
          cd ${{ github.workspace }}/OCK
          cp ${{ github.workspace }}/OpenCryptographyKitC/package/jgsk_crypto.tar .
          cp ${{ github.workspace }}/OpenCryptographyKitC/package/jgsk_crypto_sdk.tar .
          tar -xvf jgsk_crypto.tar
          tar -xvf jgsk_crypto_sdk.tar
          mkdir jgsk_sdk/lib64
          cp libjgsk8iccs_64.so jgsk_sdk/lib64
      - name: Setup Temurin JDK
        uses: actions/setup-java@v4
        with:
          java-version: '26-ea'
          distribution: 'temurin'
          architecture: 'x64'
      - name: Build OpenJCEPlus without sanitizers
        run: >
          mvn
          --batch-mode
          '-Dock.library.path=${{ github.workspace }}/OCK/'
          clean
          compile
          test-compile
        env:
          GSKIT_HOME: ${{ github.workspace }}/OCK/jgsk_sdk
      - name: Run Valgrind Memory Check on Maven Tests
        run: |
          mkdir -p ${{ github.workspace }}/target/valgrind-reports
          # Run entire Maven process under Valgrind with trace-children to follow forks
          valgrind \
            --tool=memcheck \
            --leak-check=full \
            --show-leak-kinds=definite,possible \
            --track-origins=yes \
            --log-file=${{ github.workspace }}/target/valgrind-reports/valgrind-%p.log \
            --suppressions=${{ github.workspace }}/.github/valgrind.supp \
            --error-exitcode=0 \
            --gen-suppressions=all \
            --trace-children=yes \
            --child-silent-after-fork=yes \
            mvn --batch-mode \
              -Dock.library.path=${{ github.workspace }}/OCK/ \
              -Dtest=ibm.jceplus.junit.openjceplus.TestAES \
              test
        env:
          GSKIT_HOME: ${{ github.workspace }}/OCK/jgsk_sdk
          MAVEN_OPTS: "-Xmx512m"
      - name: Analyze Valgrind Results
        if: always()
        run: |
          echo "üìä Valgrind Memory Analysis Results:"
          echo "======================================"
          
          if [ -d "${{ github.workspace }}/target/valgrind-reports" ] && [ "$(ls -A ${{ github.workspace }}/target/valgrind-reports)" ]; then
            for report in ${{ github.workspace }}/target/valgrind-reports/valgrind-*.log; do
              if [ -f "$report" ]; then
                echo ""
                echo "üìÑ Report: $(basename $report)"
                echo "---"
                
                # Extract error summary
                if grep -q "ERROR SUMMARY:" "$report"; then
                  grep "ERROR SUMMARY:" "$report"
                fi
                
                # Check for definite leaks
                if grep -q "definitely lost:" "$report"; then
                  echo "‚ö†Ô∏è DEFINITE MEMORY LEAKS FOUND:"
                  grep "definitely lost:" "$report"
                fi
                
                # Check for possible leaks
                if grep -q "possibly lost:" "$report"; then
                  echo "‚ö†Ô∏è POSSIBLE MEMORY LEAKS FOUND:"
                  grep "possibly lost:" "$report"
                fi
                
                # Check for invalid reads/writes
                if grep -q "Invalid read\|Invalid write" "$report"; then
                  echo "‚ö†Ô∏è INVALID MEMORY ACCESS FOUND:"
                  grep -A 5 "Invalid read\|Invalid write" "$report" | head -20
                fi
                
                # Check for use after free
                if grep -q "Invalid free\|Use of uninitialised" "$report"; then
                  echo "‚ö†Ô∏è USE-AFTER-FREE OR UNINITIALIZED MEMORY:"
                  grep -A 5 "Invalid free\|Use of uninitialised" "$report" | head -20
                fi
              fi
            done
            
            # Create summary
            echo ""
            echo "üìã Summary of all reports:"
            grep "ERROR SUMMARY:" ${{ github.workspace }}/target/valgrind-reports/valgrind-*.log || true
            
            # Check if any errors found
            if grep -q "ERROR SUMMARY: [1-9]" ${{ github.workspace }}/target/valgrind-reports/valgrind-*.log; then
              echo ""
              echo "::warning::Valgrind detected memory issues - see detailed reports in artifacts"
            else
              echo ""
              echo "‚úÖ No memory errors detected by Valgrind"
            fi
          else
            echo "‚ùå No Valgrind reports found"
          fi
      - name: Archive Valgrind Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: valgrind-reports
          path: ${{ github.workspace }}/target/valgrind-reports/
          if-no-files-found: warn
      - run: echo "üîç Valgrind analysis complete - status is ${{ job.status }}."
